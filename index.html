<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora Avanzada de Funciones</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f4f4f4; color: #222; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 1rem; }
    code { background: #e8e8e8; padding: 2px 4px; border-radius: 3px; }
    table { border-collapse: collapse; width: 100%; max-width: 500px; margin-top: 10px; }
    th, td { border: 1px solid #bbb; padding: 6px 12px; text-align: center; }
    pre { background: #f0f0f0; padding: 10px; max-width: 700px; white-space: pre-wrap; }
    #graph { margin-top: 30px; max-width: 700px; }
  </style>
</head>
<body>
  <h1>Calculadora Avanzada de Funciones</h1>
  <input id="eq" placeholder="Ejemplo: 1 / (x + 2)" />
  <button onclick="analizar()">Calcular</button>

  <h2>Resultados</h2>
  <p><strong>Dominio:</strong> <code id="dom"></code></p>
  <p><strong>Asíntotas verticales:</strong> <code id="asv"></code></p>
  <p><strong>Asíntotas horizontales:</strong> <code id="ash"></code></p>
  <p><strong>Rango estimado:</strong> <code id="ran"></code></p>
  <p><strong>Procedimiento rango:</strong></p>
  <pre id="proc"></pre>

  <h3>Tabla de valores</h3>
  <table>
    <thead><tr><th>x</th><th>f(x)</th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>

  <div id="graph" style="height:400px;"></div>

  <script>
  function analizar() {
    const s = document.getElementById("eq").value.trim();
    if (!s) return alert("Ingresa una función.");
    const compiled = math.compile(s);
    const excl = [];
    const xs = math.range(-20, 20, 0.02).toArray();

    // Dominio/asintotas verticales
    xs.forEach(x => {
      try {
        const y1 = compiled.evaluate({ x });
        const y2 = compiled.evaluate({ x + 0.02 });
        if (!isFinite(y1)||!isFinite(y2)||Math.abs(y2-y1)>1e3) {
          const xr = math.round(x,2);
          if (!excl.includes(xr)) excl.push(xr);
        }
      } catch {
        const xr = math.round(x,2);
        if (!excl.includes(xr)) excl.push(xr);
      }
    });

    const dom = excl.length
      ? `x ∈ ℝ, x ≠ ` + excl.join(" y x ≠ ")
      : "x ∈ ℝ";
    document.getElementById("dom").textContent = dom;
    document.getElementById("asv").textContent = excl.map(x=>`x = ${x}`).join(", ") || "Ninguna";

    // Asíntota horizontal
    let ah = "";
    try {
      const y1 = compiled.evaluate({ x: 1e6 });
      const y2 = compiled.evaluate({ x: -1e6 });
      if (isFinite(y1) && isFinite(y2) && Math.abs(y1 - y2) < 0.01) {
        ah = "y = " + math.round((y1+y2)/2,5);
      }
    } catch {}
    document.getElementById("ash").textContent = ah || "Ninguna";

    // Rango y procedimiento sencillo
    let proc = "", rang = "";
    proc += `f(x) = ${s}\n`;
    if (s.includes("1/(")) {
      proc += "Procedimiento simplificado para inversa.\n";
      rang = "y ∈ ℝ, y ≠ 0";
    } else {
      rang = "Valor entre mínimos y máximos evaluados.";
    }
    document.getElementById("proc").textContent = proc;
    document.getElementById("ran").textContent = rang;

    // Tabla de valores
    const tableXs = [-10,-5,-3,-2,-1,0,1,2,3,5,10];
    const tbody = tableXs.map(x=>{
      let y="NaN";
      try { y = math.round(compiled.evaluate({ x }),5); } catch {}
      return `<tr><td>${x}</td><td>${y}</td></tr>`;
    }).join("");
    document.getElementById("tabla").innerHTML = tbody;

    // Gráfica
    const plotX = [], plotY = [];
    for (let x = -10; x <= 10; x += 0.1) {
      try { plotY.push(compiled.evaluate({ x })); }
      catch { plotY.push(null); }
      plotX.push(x);
    }
    const shapes = [];
    excl.forEach(v=>{
      const xv = Number(v);
      shapes.push({ type: "line", x0: xv, x1: xv, y0: -1e3, y1: 1e3, line:{dash:"dashdot",color:"red"} });
    });
    if (ah) {
      const yv = +ah.split("=").pop();
      shapes.push({type:"line",x0:-10,x1:10,y0:yv,y1:yv,line:{dash:"dashdot",color:"blue"}});
    }

    Plotly.newPlot("graph",[{
      x: plotX, y: plotY, mode:"lines", line:{color:"green"}
    }], {
      title:"Gráfica de f(x)", xaxis:{title:"x"}, yaxis:{title:"y"}, shapes
    });
  }
  </script>
</body>
</html>
