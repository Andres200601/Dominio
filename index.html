<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Ecuaciones</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f4f4;
      color: #222;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
    }
    code {
      background: #e8e8e8;
      padding: 3px 6px;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 6px 12px;
      text-align: center;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-width: 700px;
    }
    #graph {
      margin-top: 30px;
      max-width: 700px;
    }
  </style>
</head>
<body>

  <h1>Calculadora de Ecuaciones</h1>

  <label for="eq">Ingresa la ecuación (ej: 1 / (x + 2)):</label>
  <input type="text" id="eq" placeholder="Ejemplo: sin(x) / (x + 1)" />
  <button onclick="analizar()">Calcular</button>

  <h2>Resultados:</h2>
  <p><strong>Dominio:</strong> <code id="dom"></code></p>
  <p><strong>Asíntotas verticales:</strong> <code id="asv"></code></p>
  <p><strong>Asíntotas horizontales (aproximadas):</strong> <code id="ash"></code></p>

  <p><strong>Procedimiento para Rango:</strong></p>
  <pre id="proc"></pre>
  <p><strong>Rango estimado:</strong> <code id="ran"></code></p>

  <h3>Tabla de valores (x, f(x))</h3>
  <table>
    <thead><tr><th>x</th><th>f(x)</th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>

  <div id="graph"></div>

<script>
function analizar() {
  const input = document.getElementById("eq").value.trim();
  if (!input) {
    alert("Por favor, ingresa una ecuación válida.");
    return;
  }

  let expr;
  try {
    expr = math.parse(input);
  } catch (e) {
    alert("Ecuación no válida.");
    return;
  }

  const compiled = math.compile(input);
  const dominioExclusiones = [];

  // Detectar valores que hacen el denominador igual a 0
  expr.traverse(function (node) {
    if (node.type === "OperatorNode" && node.op === "/") {
      const denominador = node.args[1];
      try {
        const zeros = math.solve(math.simplify(denominador), 'x');
        zeros.forEach(z => {
          const val = math.format(z, { precision: 5 });
          if (!dominioExclusiones.includes(val)) {
            dominioExclusiones.push(val);
          }
        });
      } catch (e) {}
    }
  });

  const domStr = dominioExclusiones.length
    ? `x ∈ ℝ, x ≠ ${dominioExclusiones.join(" y x ≠ ")}`
    : "x ∈ ℝ";

  // Evaluar tabla de valores
  const xVals = [-10, -5, -3, -2, -1, 0, 1, 2, 3, 5, 10];
  const yVals = [];
  let minY = Infinity, maxY = -Infinity;
  let tablaHTML = "";

  xVals.forEach(x => {
    try {
      const y = compiled.evaluate({ x });
      const val = math.round(y, 5);
      yVals.push(val);
      if (!isNaN(val)) {
        minY = Math.min(minY, val);
        maxY = Math.max(maxY, val);
      }
      tablaHTML += `<tr><td>${x}</td><td>${val}</td></tr>`;
    } catch {
      yVals.push(NaN);
      tablaHTML += `<tr><td>${x}</td><td>Indefinido</td></tr>`;
    }
  });

  // Asíntotas verticales
  const asintotasV = dominioExclusiones.map(val => `x = ${val}`).join(", ") || "Ninguna";

  // Asíntota horizontal aproximada
  let asintotaH = null;
  try {
    const limPos = compiled.evaluate({ x: 1e6 });
    const limNeg = compiled.evaluate({ x: -1e6 });
    if (Math.abs(limPos - limNeg) < 0.1) {
      asintotaH = math.round((limPos + limNeg) / 2, 5);
    }
  } catch {}
  const ashStr = asintotaH !== null ? `y = ${asintotaH}` : "No se detectó";

  // Rango aproximado
  const rango = `R ≈ { y ∈ ℝ | ${minY} ≤ y ≤ ${maxY} }`;

  // Procedimiento ejemplo
  const proc = `Ecuación: y = ${input}
Evaluamos valores de x para estimar el rango visualmente.`;

  // Mostrar resultados
  document.getElementById("dom").textContent = `D = { ${domStr} }`;
  document.getElementById("asv").textContent = asintotasV;
  document.getElementById("ash").textContent = ashStr;
  document.getElementById("ran").textContent = rango;
  document.getElementById("proc").textContent = proc;
  document.getElementById("tabla").innerHTML = tablaHTML;

  // Graficar
  const trace = {
    x: xVals,
    y: yVals,
    mode: "lines+markers",
    type: "scatter",
    line: { color: "green" },
    marker: { color: "orange", size: 8 }
  };

  const layout = {
    title: "Gráfica de la función",
    xaxis: { title: "x" },
    yaxis: { title: "f(x)" },
    shapes: []
  };

  dominioExclusiones.forEach(val => {
    const xNum = Number(val);
    if (!isNaN(xNum)) {
      layout.shapes.push({
        type: "line",
        x0: xNum,
        x1: xNum,
        y0: minY,
        y1: maxY,
        line: { dash: "dot", color: "red" }
      });
    }
  });

  if (asintotaH !== null) {
    layout.shapes.push({
      type: "line",
      x0: Math.min(...xVals),
      x1: Math.max(...xVals),
      y0: asintotaH,
      y1: asintotaH,
      line: { dash: "dot", color: "blue" }
    });
  }

  Plotly.newPlot("graph", [trace], layout);
}
</script>

</body>
</html>
