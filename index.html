<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Graficador Función con Asíntotas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  body { max-width: 900px; margin: auto; font-family: Arial, sans-serif; padding: 20px; }
  input, button { width: 100%; font-size: 1.2em; padding: 10px; margin: 10px 0; }
  canvas { border: 1px solid #ccc; background: #f9f9f9; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background: #eee; }
  .info { font-weight: bold; margin-top: 15px; }
</style>
</head>
<body>

<h2>Graficador Función con Asíntotas</h2>
<input id="funcion" type="text" value="2 / (x - 2)" placeholder="Ej: 2/(x-2)" />
<button onclick="graficar()">Graficar</button>

<div class="info" id="dominio"></div>
<div class="info" id="rango"></div>

<canvas id="grafica" width="800" height="400"></canvas>

<div id="tablaValores"></div>

<script>
let chart;

function graficar() {
  const input = document.getElementById("funcion").value.trim();
  if (!input) {
    alert("Por favor ingresa una función.");
    return;
  }

  let f;
  try {
    f = math.compile(input);
  } catch(e) {
    alert("Función inválida: " + e.message);
    return;
  }

  const xs = [];
  const ys = [];
  const excluidos = new Set();

  let minY = Infinity;
  let maxY = -Infinity;

  // Muestreamos en pasos pequeños para buena gráfica
  for(let x = -20; x <= 20; x += 0.05) {
    try {
      const y = f.evaluate({ x });
      if(typeof y === "number" && isFinite(y)) {
        xs.push(+x.toFixed(3));
        ys.push(y);
        if(y < minY) minY = y;
        if(y > maxY) maxY = y;
      } else {
        excluidos.add(+x.toFixed(3));
      }
    } catch {
      excluidos.add(+x.toFixed(3));
    }
  }

  // Detectar asíntotas verticales agrupando valores excluidos cercanos (diferencia >0.4)
  const excluidosArr = [...excluidos].sort((a,b) => a-b);
  const asintotasV = [];
  for(let i = 0; i < excluidosArr.length; i++) {
    if(i === 0 || (excluidosArr[i] - excluidosArr[i-1]) > 0.4) {
      asintotasV.push(excluidosArr[i]);
    }
  }

  // Detectar asíntota horizontal evaluando para valores grandes de x
  let asintotaH = null;
  try {
    const yPos = f.evaluate({ x: 1e6 });
    const yNeg = f.evaluate({ x: -1e6 });
    if(Math.abs(yPos - yNeg) < 1e-3 && Math.abs(yPos) < 1e6) {
      asintotaH = yPos;
    }
  } catch {}

  // Mostrar dominio y rango
  document.getElementById("dominio").textContent = 
    asintotasV.length > 0 
    ? `Dominio: { x ∈ ℝ | x ≠ ${asintotasV.map(v => v.toFixed(2)).join(", ")} }`
    : "Dominio: ℝ";

  document.getElementById("rango").textContent = 
    asintotaH !== null
    ? `Rango: { y ∈ ℝ | y ≠ ${asintotaH.toFixed(2)} }`
    : `Rango aproximado: [${minY.toFixed(2)}, ${maxY.toFixed(2)}]`;

  // Separar en segmentos para no dibujar líneas que cruzan discontinuidades grandes
  const datasets = [];
  let segmento = [];

  for(let i = 0; i < xs.length; i++) {
    if(i > 0 && Math.abs(ys[i] - ys[i-1]) > 20) {
      if(segmento.length > 0) {
        datasets.push({
          label: "f(x)",
          data: segmento,
          borderColor: "blue",
          showLine: true,
          pointRadius: 3,
          fill: false,
          tension: 0.15
        });
        segmento = [];
      }
    }
    segmento.push({ x: xs[i], y: ys[i] });
  }
  if(segmento.length > 0) {
    datasets.push({
      label: "f(x)",
      data: segmento,
      borderColor: "blue",
      showLine: true,
      pointRadius: 3,
      fill: false,
      tension: 0.15
    });
  }

  // Configurar asíntotas con anotaciones
  const annotations = {};
  asintotasV.forEach((xv, i) => {
    annotations["vline" + i] = {
      type: "line",
      xMin: xv,
      xMax: xv,
      borderColor: "red",
      borderWidth: 2,
      borderDash: [6,6],
      label: {
        content: `x=${xv.toFixed(2)}`,
        enabled: true,
        position: "start",
        backgroundColor: "rgba(255,0,0,0.7)",
        color: "white",
        font: { size: 12 }
      }
    };
  });
  if(asintotaH !== null) {
    annotations["hline"] = {
      type: "line",
      yMin: asintotaH,
      yMax: asintotaH,
      borderColor: "green",
      borderWidth: 2,
      borderDash: [6,6],
      label: {
        content: `y=${asintotaH.toFixed(2)}`,
        enabled: true,
        position: "start",
        backgroundColor: "rgba(0,128,0,0.7)",
        color: "white",
        font: { size: 12 }
      }
    };
  }

  // Crear o actualizar gráfico
  const ctx = document.getElementById("grafica").getContext("2d");
  if(chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "scatter",
    data: { datasets: datasets },
    options: {
      responsive: false,
      scales: {
        x: {
          type: "linear",
          position: "bottom",
          title: { display: true, text: "x", font: { size: 16 } },
          ticks: { stepSize: 5 },
          grid: { color: "#ccc" }
        },
        y: {
          type: "linear",
          title: { display: true, text: "f(x)", font: { size: 16 } },
          grid: { color: "#ccc" },
          min: minY - Math.abs(minY)*0.15,
          max: maxY + Math.abs(maxY)*0.15,
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `x: ${ctx.parsed.x.toFixed(3)}, y: ${ctx.parsed.y.toFixed(3)}`
          }
        },
        annotation: { annotations: annotations }
      }
    },
    plugins: [Chart.registry.getPlugin('annotation')]
  });

  // Mostrar tabla de valores (cada 10 valores para no saturar)
  let tabla = `<table><thead><tr><th>x</th><th>f(x)</th></tr></thead><tbody>`;
  for(let i = 0; i < xs.length; i += 10) {
    tabla += `<tr><td>${xs[i].toFixed(3)}</td><td>${ys[i].toFixed(4)}</td></tr>`;
  }
  tabla += "</tbody></table>";
  document.getElementById("tablaValores").innerHTML = tabla;
}
</script>

</body>
</html>
