<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Graficador con Asíntotas y Tabla</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  body { font-family: Arial; padding: 20px; max-width: 900px; margin: auto; }
  input, button { width: 400px; padding: 8px; margin-bottom: 15px; }
  canvas { margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background: #eee; }
  .asintotas { margin: 10px 0; font-weight: bold; }
</style>
</head>
<body>

<h2>Graficador con Asíntotas y Tabla de Valores</h2>
<input id="funcion" type="text" value="2 / (x - 2)" />
<button onclick="graficar()">Graficar función</button>

<p id="dominio"></p>
<p id="rango"></p>
<p class="asintotas" id="asintotas"></p>

<canvas id="grafica" width="800" height="400"></canvas>

<div id="tablaValores"></div>

<script>
  let chart;

  function graficar() {
    const expr = document.getElementById("funcion").value.trim();
    const f = math.compile(expr);

    const xs = [];
    const ys = [];

    const dominioExcluidos = new Set();
    let minY = Infinity, maxY = -Infinity;

    for (let x = -20; x <= 20; x += 0.1) {
      try {
        const y = f.evaluate({ x });
        if (isFinite(y)) {
          xs.push(Number(x.toFixed(2)));
          ys.push(y);
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        } else {
          dominioExcluidos.add(Number(x.toFixed(2)));
        }
      } catch {
        dominioExcluidos.add(Number(x.toFixed(2)));
      }
    }

    const asintotasVerticales = [...dominioExcluidos].sort((a,b) => a-b);

    const yInfPos = f.evaluate({ x: 1e6 });
    const yInfNeg = f.evaluate({ x: -1e6 });
    let asintotaHorizontal = null;
    if (Math.abs(yInfPos) < 1e-3 && Math.abs(yInfNeg) < 1e-3) {
      asintotaHorizontal = 0;
    }

    const dominioStr = `Dominio: {x ∈ ℝ | x ≠ ${asintotasVerticales.join(', ')}}`;
    const rangoStr = asintotaHorizontal !== null
      ? `Rango: {y ∈ ℝ | y ≠ ${asintotaHorizontal}}`
      : `Rango aproximado: [${minY.toFixed(2)}, ${maxY.toFixed(2)}]`;

    document.getElementById("dominio").textContent = dominioStr;
    document.getElementById("rango").textContent = rangoStr;

    // Separar datos en segmentos para evitar líneas en saltos grandes (asintotas)
    const datasets = [];
    let currentSegment = [];

    for(let i = 0; i < xs.length; i++) {
      if(i > 0 && Math.abs(ys[i] - ys[i-1]) > 50) {
        if(currentSegment.length > 0) {
          datasets.push({
            label: "f(x)",
            data: currentSegment,
            borderColor: "blue",
            showLine: true,
            pointRadius: 3,
            fill: false,
            tension: 0.1,
          });
          currentSegment = [];
        }
      }
      currentSegment.push({ x: xs[i], y: ys[i] });
    }
    if(currentSegment.length > 0) {
      datasets.push({
        label: "f(x)",
        data: currentSegment,
        borderColor: "blue",
        showLine: true,
        pointRadius: 3,
        fill: false,
        tension: 0.1,
      });
    }

    const annotations = {};
    asintotasVerticales.forEach((xv, i) => {
      annotations['vline' + i] = {
        type: 'line',
        xMin: xv,
        xMax: xv,
        borderColor: 'red',
        borderWidth: 2,
        borderDash: [6, 6],
        label: {
          content: `x=${xv}`,
          enabled: true,
          position: 'start',
          backgroundColor: 'rgba(255,0,0,0.7)',
          color: 'white',
          font: { size: 12 }
        }
      };
    });
    if(asintotaHorizontal !== null) {
      annotations['hline'] = {
        type: 'line',
        yMin: asintotaHorizontal,
        yMax: asintotaHorizontal,
        borderColor: 'green',
        borderWidth: 2,
        borderDash: [6, 6],
        label: {
          content: `y=${asintotaHorizontal}`,
          enabled: true,
          position: 'start',
          backgroundColor: 'rgba(0,128,0,0.7)',
          color: 'white',
          font: { size: 12 }
        }
      };
    }

    const ctx = document.getElementById("grafica").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets: datasets },
      options: {
        responsive: false,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'x' },
          },
          y: {
            title: { display: true, text: 'f(x)' },
            beginAtZero: false,
            // Agregamos un margen extra para que no quede tan apretado
            min: minY - Math.abs(minY)*0.1,
            max: maxY + Math.abs(maxY)*0.1,
          }
        },
        plugins: {
          legend: { display: false },
          annotation: {
            annotations: annotations
          }
        }
      },
      plugins: [Chart.registry.getPlugin('annotation')]
    });

    // Tabla valores
    let html = `<table><thead><tr><th>x</th><th>f(x)</th></tr></thead><tbody>`;
    for(let i=0; i<xs.length; i+=5){
      html += `<tr><td>${xs[i].toFixed(2)}</td><td>${ys[i].toFixed(4)}</td></tr>`;
    }
    html += `</tbody></table>`;
    document.getElementById("tablaValores").innerHTML = html;
  }
</script>

</body>
</html>
