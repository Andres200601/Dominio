<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Ecuaciones</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f4f4;
      color: #222;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
    }
    code {
      background: #e8e8e8;
      padding: 3px 6px;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 6px 12px;
      text-align: center;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-width: 700px;
    }
    #graph {
      margin-top: 30px;
      max-width: 700px;
      height: 400px;
    }
  </style>
</head>
<body>

  <h1>Calculadora de Ecuaciones</h1>

  <input type="text" id="eq" placeholder="Ejemplo: 1 / (x + 2)" />
  <button onclick="analizar()">Calcular</button>

  <h2>Resultados:</h2>
  <p><strong>Dominio:</strong> <code id="dom"></code></p>
  <p><strong>Asíntotas verticales:</strong> <code id="asv"></code></p>
  <p><strong>Asíntotas horizontales:</strong> <code id="ash"></code></p>
  <p><strong>Rango estimado:</strong> <code id="ran"></code></p>
  <p><strong>Procedimiento:</strong></p>
  <pre id="proc"></pre>

  <h3>Tabla de valores</h3>
  <table>
    <thead><tr><th>x</th><th>f(x)</th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>

  <div id="graph"></div>

  <script>
    function analizar() {
      const input = document.getElementById("eq").value.trim();
      if (!input) {
        alert("Ingresa una ecuación válida.");
        return;
      }

      const compiled = math.compile(input);
      const xs = math.range(-20, 20, 0.1).toArray();
      const excl = new Set();
      const puntosX = [], puntosY = [];
      let yMin = Infinity, yMax = -Infinity;

      // Detectar asíntotas verticales (división por cero o explosión de valores)
      xs.forEach(x => {
        try {
          const y = compiled.evaluate({ x });
          if (!isFinite(y) || Math.abs(y) > 1e5) {
            excl.add(x.toFixed(2));
          } else {
            puntosX.push(x);
            puntosY.push(y);
            yMin = Math.min(yMin, y);
            yMax = Math.max(yMax, y);
          }
        } catch {
          excl.add(x.toFixed(2));
        }
      });

      // Dominio y asíntotas
      const exclSorted = Array.from(excl).map(Number).sort((a, b) => a - b);
      const dominio = exclSorted.length
        ? `x ∈ ℝ, x ≠ ${exclSorted.join(' y x ≠ ')}`
        : 'x ∈ ℝ';
      document.getElementById("dom").textContent = dominio;
      document.getElementById("asv").textContent = exclSorted.map(x => `x = ${x}`).join(", ") || "Ninguna";

      // Asíntota horizontal aproximada
      let ah = "Ninguna";
      try {
        const y1 = compiled.evaluate({ x: 1e6 });
        const y2 = compiled.evaluate({ x: -1e6 });
        if (isFinite(y1) && isFinite(y2) && Math.abs(y1 - y2) < 0.1) {
          ah = "y = " + math.round((y1 + y2) / 2, 5);
        }
      } catch {}
      document.getElementById("ash").textContent = ah;

      // Rango estimado
      const rang = input.includes("1/(") || input.includes("1/(x")
        ? "y ∈ ℝ, y ≠ 0"
        : `Aproximadamente entre y = ${math.round(yMin, 3)} y y = ${math.round(yMax, 3)}`;
      document.getElementById("ran").textContent = rang;

      // Procedimiento mostrado
      let proc = `Ecuación original: y = ${input}\n`;
      if (input === "1 / (x + 2)") {
        proc += `y(x + 2) = 1\n⇒ xy + 2y = 1\n⇒ x = (1 - 2y) / y\nRango: y ≠ 0`;
      }
      document.getElementById("proc").textContent = proc;

      // Tabla de valores
      const puntosTabla = [-10,-5,-3,-2,-1,0,1,2,3,5,10];
      let tablaHTML = "";
      puntosTabla.forEach(x => {
        let y = "Indefinido";
        try {
          const val = compiled.evaluate({ x });
          if (isFinite(val)) y = math.round(val, 5);
        } catch {}
        tablaHTML += `<tr><td>${x}</td><td>${y}</td></tr>`;
      });
      document.getElementById("tabla").innerHTML = tablaHTML;

      // Gráfica
      const shapes = exclSorted.map(x => ({
        type: "line", x0: x, x1: x, y0: yMin, y1: yMax,
        line: { dash: "dot", color: "red" }
      }));
      if (ah.startsWith("y = ")) {
        const yval = parseFloat(ah.split("=")[1]);
        shapes.push({
          type: "line", x0: -20, x1: 20, y0: yval, y1: yval,
          line: { dash: "dot", color: "blue" }
        });
      }

      Plotly.newPlot("graph", [{
        x: puntosX,
        y: puntosY,
        mode: "lines",
        line: { color: "green" }
      }], {
        title: "Gráfica de la función",
        shapes,
        xaxis: { title: "x" },
        yaxis: { title: "f(x)" }
      });
    }
  </script>
</body>
</html>
