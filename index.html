<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Ecuaciones con Dominio y Rango Detallados</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f4f4;
      color: #222;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
    }
    code {
      background: #e8e8e8;
      padding: 3px 6px;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 6px 12px;
      text-align: center;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-width: 700px;
    }
    #graph {
      margin-top: 30px;
      max-width: 700px;
    }
  </style>
</head>
<body>

  <h1>Calculadora de Ecuaciones con Dominio y Rango Detallados</h1>

  <label for="eq">Ingresa la ecuación (ej: 1 / (x + 2)):</label>
  <input type="text" id="eq" placeholder="Ejemplo: sin(x) / (x + 1)" />
  <button onclick="analizar()">Calcular</button>

  <h2>Resultados:</h2>

  <p><strong>Dominio:</strong> <code id="dom"></code></p>
  <p><strong>Procedimiento para Rango:</strong></p>
  <pre id="proc"></pre>
  <p><strong>Rango estimado:</strong> <code id="ran"></code></p>

  <h3>Tabla de valores (x, f(x))</h3>
  <table>
    <thead><tr><th>x</th><th>f(x)</th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>

  <div id="graph"></div>

<script>
  function analizar() {
    const input = document.getElementById("eq").value.trim();

    if (!input) {
      alert("Por favor, ingresa una ecuación válida.");
      return;
    }

    let dominioExclusiones = [];
    let procedimiento = "";

    const xVals = [-3, -2, -1, 0, 1, 2, 3];
    const yVals = [];
    let tablaHTML = "";
    let minY = Infinity, maxY = -Infinity;
    let rangoExcepcion = false;

    try {
      const expr = math.parse(input);
      const compiled = math.compile(input);

      // Detectar denominadores para dominio
      expr.traverse(node => {
        if (node.type === "OperatorNode" && node.op === "/") {
          const denomNode = node.args[1];
          const denomStr = denomNode.toString();
          if (!dominioExclusiones.includes(denomStr)) {
            dominioExclusiones.push(denomStr);
          }
        }
        if (node.type === "FunctionNode" && node.fn.name === "sqrt") {
          const inside = node.args[0].toString();
          procedimiento += `Restricción: sqrt(${inside}) ⇒ ${inside} ≥ 0\n`;
        }
      });

      // Mostrar dominio
      let domStr = "x ∈ ℝ";
      if (dominioExclusiones.length > 0) {
        domStr = `x ∈ ℝ, excepto donde `;
        domStr += dominioExclusiones.map(denom => `(${denom}) = 0`).join(" o ");
      }

      // Procedimiento especial para funciones 1/(x + c)
      let procedimientoExtra = "";
      try {
        const fracCheck = math.parse(input);

        if (fracCheck.type === "OperatorNode" && fracCheck.op === "/") {
          const numer = fracCheck.args[0].toString();
          let denom = fracCheck.args[1].toString();

          // Quitar paréntesis si existen en denominador para análisis simple
          denom = denom.replace(/^\(|\)$/g, "").trim();

          // Regex para detectar x + c o x - c (c número)
          const denomMatch = denom.match(/^x\s*([\+\-])\s*(\d+)$/);
          if (numer === "1" && denomMatch) {
            const signo = denomMatch[1];
            const num = denomMatch[2];
            procedimientoExtra +=
              `\nProcedimiento especial para despeje:\n` +
              `y = 1/(x ${signo} ${num})\n` +
              `⇒ y(x ${signo} ${num}) = 1\n` +
              `⇒ xy ${signo} ${num}y = 1\n` +
              `⇒ x = (1 ${signo === "+" ? "-" : "+"} ${num}y) / y\n`;
            rangoExcepcion = true;
          }
        }
      } catch (e) {
        // No hacer nada
      }
      procedimiento += procedimientoExtra;

      // Calcular tabla y rango aproximado
      for (let x of xVals) {
        try {
          let yVal = compiled.evaluate({ x });
          yVal = math.round(yVal, 5);
          yVals.push(yVal);
          if (!isNaN(yVal)) {
            minY = Math.min(minY, yVal);
            maxY = Math.max(maxY, yVal);
          }
          tablaHTML += `<tr><td>${x}</td><td>${yVal}</td></tr>`;
        } catch {
          tablaHTML += `<tr><td>${x}</td><td>NaN</td></tr>`;
        }
      }

      document.getElementById("dom").textContent = `D = { ${domStr} }`;
      document.getElementById("proc").textContent = procedimiento;

      if (rangoExcepcion) {
        document.getElementById("ran").textContent = `R = { y | y ∈ ℝ, y ≠ 0 }`;
      } else {
        document.getElementById("ran").textContent = `R ≈ { y ∈ ℝ | ${minY} ≤ y ≤ ${maxY} }`;
      }

      document.getElementById("tabla").innerHTML = tablaHTML;

      // Graficar
      Plotly.newPlot("graph", [{
        x: xVals,
        y: yVals,
        mode: "lines+markers",
        type: "scatter",
        line: { color: "green" },
        marker: { color: "yellow", size: 8 }
      }], {
        title: "Gráfica de la función",
        xaxis: { title: "x" },
        yaxis: { title: "f(x)" },
        margin: { t: 40 }
      });

    } catch (error) {
      alert("Error: " + error.message);
    }
  }
</script>

</body>
</html>
