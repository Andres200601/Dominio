<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Ecuaciones</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      width: 100%;
      margin: 5px 0;
    }
    code {
      background: #eaeaea;
      padding: 2px 5px;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    #graph {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>Calculadora de Funciones</h2>

<input id="eq" type="text" placeholder="Ejemplo: 1 / (x + 2)">
<button onclick="analizar()">Calcular</button>

<p><strong>Dominio:</strong> <code id="dom"></code></p>
<p><strong>Asíntotas verticales:</strong> <code id="asv"></code></p>
<p><strong>Asíntotas horizontales:</strong> <code id="ash"></code></p>
<p><strong>Rango aproximado:</strong> <code id="ran"></code></p>
<pre id="proc"></pre>

<h3>Tabla de valores</h3>
<table>
  <thead><tr><th>x</th><th>f(x)</th></tr></thead>
  <tbody id="tabla"></tbody>
</table>

<div id="graph"></div>

<script>
function analizar() {
  const input = document.getElementById("eq").value;
  let expr, compiled;

  try {
    expr = math.parse(input);
    compiled = math.compile(input);
  } catch (e) {
    alert("Error en la expresión");
    return;
  }

  const xVals = [-10, -5, -3, -2, -1, 0, 1, 2, 3, 5, 10];
  const yVals = [];
  let tablaHTML = '';
  let dominioExcluido = [];
  let asintotasV = [];

  expr.traverse(node => {
    if (node.type === "OperatorNode" && node.op === "/") {
      try {
        const den = node.args[1];
        const simplified = math.simplify(den).toString();
        const solutions = math.evaluate(`solve(${simplified} = 0, x)`);
        const arr = Array.isArray(solutions) ? solutions : [solutions];
        arr.forEach(sol => {
          const val = math.round(sol, 5);
          if (!dominioExcluido.includes(val)) {
            dominioExcluido.push(val);
            asintotasV.push(`x = ${val}`);
          }
        });
      } catch {}
    }
  });

  let domStr = "x ∈ ℝ";
  if (dominioExcluido.length === 1) {
    domStr += `, x ≠ ${dominioExcluido[0]}`;
  } else if (dominioExcluido.length > 1) {
    domStr += dominioExcluido.map(x => `, x ≠ ${x}`).join("");
  }

  let minY = Infinity, maxY = -Infinity;

  for (let x of xVals) {
    try {
      const y = compiled.evaluate({x});
      if (typeof y === "number" && isFinite(y)) {
        const r = math.round(y, 5);
        yVals.push(r);
        tablaHTML += `<tr><td>${x}</td><td>${r}</td></tr>`;
        minY = Math.min(minY, r);
        maxY = Math.max(maxY, r);
      } else {
        tablaHTML += `<tr><td>${x}</td><td>undefined</td></tr>`;
      }
    } catch {
      tablaHTML += `<tr><td>${x}</td><td>undefined</td></tr>`;
    }
  }

  // Asíntota horizontal (evaluación a ±infinito)
  let asH = "No determinada";
  try {
    const limPos = compiled.evaluate({x: 1e6});
    const limNeg = compiled.evaluate({x: -1e6});
    if (Math.abs(limPos - limNeg) < 1e-2) {
      const aprox = math.round((limPos + limNeg)/2, 5);
      asH = `y = ${aprox}`;
    }
  } catch {}

  // Rango estimado
  let proc = "";
  let rango = `R ≈ [${math.round(minY, 5)}, ${math.round(maxY, 5)}]`;

  if (/^1\/\(x[+-]\d+\)$/.test(input.replace(/\s+/g, ""))) {
    proc = "Función tipo 1/(x ± a). El valor y = 0 nunca se alcanza.";
    rango = "R = ℝ, y ≠ 0";
  }

  // Mostrar en HTML
  document.getElementById("dom").textContent = `D = { ${domStr} }`;
  document.getElementById("asv").textContent = asintotasV.join(", ") || "Ninguna";
  document.getElementById("ash").textContent = asH;
  document.getElementById("ran").textContent = rango;
  document.getElementById("proc").textContent = proc || "Rango estimado con valores numéricos.";
  document.getElementById("tabla").innerHTML = tablaHTML;

  // Gráfico
  const trace = {
    x: xVals,
    y: yVals,
    type: "scatter",
    mode: "lines+markers",
    line: {color: "green"},
    marker: {color: "orange", size: 6}
  };

  const layout = {
    title: "Gráfico de la función",
    xaxis: {title: "x"},
    yaxis: {title: "f(x)"},
    shapes: []
  };

  dominioExcluido.forEach(x => {
    layout.shapes.push({
      type: "line",
      x0: x, x1: x,
      y0: minY, y1: maxY,
      line: {color: "red", dash: "dot"}
    });
  });

  if (asH.includes("y =")) {
    const yVal = parseFloat(asH.split("=")[1]);
    layout.shapes.push({
      type: "line",
      x0: Math.min(...xVals),
      x1: Math.max(...xVals),
      y0: yVal, y1: yVal,
      line: {color: "blue", dash: "dot"}
    });
  }

  Plotly.newPlot("graph", [trace], layout);
}
</script>

</body>
</html>
