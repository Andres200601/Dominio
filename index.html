<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Graficador con Asíntotas y Tabla</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
  input, button { width: 100%; padding: 8px; margin: 10px 0; font-size: 1.1em; }
  canvas { background: #f9f9f9; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
  .info { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>Graficador con Asíntotas y Tabla</h2>
<input id="funcion" type="text" value="2 / (x - 2)" placeholder="Ingresa la función, ej: 2/(x-2)" />
<button onclick="graficar()">Graficar función</button>

<div class="info" id="dominio"></div>
<div class="info" id="rango"></div>

<canvas id="grafica" width="800" height="400"></canvas>

<div id="tablaValores"></div>

<script>
  let chart;

  function graficar() {
    const inputFunc = document.getElementById("funcion").value.trim();
    if (!inputFunc) {
      alert("Por favor ingresa una función válida.");
      return;
    }

    let f;
    try {
      f = math.compile(inputFunc);
    } catch (e) {
      alert("Error al compilar la función: " + e.message);
      return;
    }

    const xs = [];
    const ys = [];
    const dominioExcluidos = new Set();

    let minY = Infinity;
    let maxY = -Infinity;

    // Muestreo en pasos pequeños, y detectamos puntos no definidos (asíntotas verticales)
    for (let x = -20; x <= 20; x += 0.05) {
      try {
        const y = f.evaluate({ x });
        if (typeof y === "number" && isFinite(y)) {
          xs.push(+x.toFixed(3));
          ys.push(y);
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        } else {
          dominioExcluidos.add(+x.toFixed(3));
        }
      } catch {
        dominioExcluidos.add(+x.toFixed(3));
      }
    }

    // Detectar asíntotas verticales agrupando valores cercanos excluidos
    const asintotasVerticales = [];
    const excluidosArr = [...dominioExcluidos].sort((a,b) => a-b);

    for (let i = 0; i < excluidosArr.length; i++) {
      if (i === 0 || (excluidosArr[i] - excluidosArr[i-1]) > 0.5) {
        asintotasVerticales.push(excluidosArr[i]);
      }
    }

    // Detectar asíntota horizontal aproximada evaluando para grandes |x|
    let asintotaHorizontal = null;
    try {
      const yPos = f.evaluate({ x: 1e6 });
      const yNeg = f.evaluate({ x: -1e6 });
      if (Math.abs(yPos - yNeg) < 1e-3 && Math.abs(yPos) < 1e6) {
        asintotaHorizontal = yPos;
      }
    } catch {}

    // Mostrar dominio y rango en formato claro
    const dominioStr = asintotasVerticales.length > 0
      ? `Dominio: { x ∈ ℝ | x ≠ ${asintotasVerticales.map(v=>v.toFixed(2)).join(", ")} }`
      : "Dominio: ℝ";

    const rangoStr = asintotaHorizontal !== null
      ? `Rango: { y ∈ ℝ | y ≠ ${asintotaHorizontal.toFixed(2)} }`
      : `Rango aproximado: [${minY.toFixed(2)}, ${maxY.toFixed(2)}]`;

    document.getElementById("dominio").textContent = dominioStr;
    document.getElementById("rango").textContent = rangoStr;

    // Separar datos para no conectar puntos separados por salto grande (asíntotas verticales)
    const datasets = [];
    let segment = [];

    for(let i=0; i<xs.length; i++) {
      if(i>0 && Math.abs(ys[i] - ys[i-1]) > 20) {
        if(segment.length > 0) {
          datasets.push({
            label: "f(x)",
            data: segment,
            borderColor: "blue",
            showLine: true,
            pointRadius: 3,
            fill: false,
            tension: 0.15,
          });
          segment = [];
        }
      }
      segment.push({ x: xs[i], y: ys[i] });
    }
    if(segment.length > 0) {
      datasets.push({
        label: "f(x)",
        data: segment,
        borderColor: "blue",
        showLine: true,
        pointRadius: 3,
        fill: false,
        tension: 0.15,
      });
    }

    // Configurar anotaciones para asíntotas
    const annotations = {};
    asintotasVerticales.forEach((xv, i) => {
      annotations["vline" + i] = {
        type: "line",
        xMin: xv,
        xMax: xv,
        borderColor: "red",
        borderWidth: 2,
        borderDash: [6, 6],
        label: {
          content: `x=${xv.toFixed(2)}`,
          enabled: true,
          position: "start",
          backgroundColor: "rgba(255,0,0,0.7)",
          color: "white",
          font: { size: 12 }
        }
      };
    });
    if(asintotaHorizontal !== null) {
      annotations["hline"] = {
        type: "line",
        yMin: asintotaHorizontal,
        yMax: asintotaHorizontal,
        borderColor: "green",
        borderWidth: 2,
        borderDash: [6,6],
        label: {
          content: `y=${asintotaHorizontal.toFixed(2)}`,
          enabled: true,
          position: "start",
          backgroundColor: "rgba(0,128,0,0.7)",
          color: "white",
          font: { size: 12 }
        }
      };
    }

    // Crear o actualizar gráfico
    const ctx = document.getElementById("grafica").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: datasets,
      },
      options: {
        responsive: false,
        scales: {
          x: {
            type: "linear",
            position: "bottom",
            title: {
              display: true,
              text: "x",
              font: { size: 16 }
            },
            ticks: { stepSize: 5 },
            grid: { drawOnChartArea: true, color: "#ccc" },
          },
          y: {
            type: "linear",
            title: {
              display: true,
              text: "f(x)",
              font: { size: 16 }
            },
            grid: { drawOnChartArea: true, color: "#ccc" },
            beginAtZero: false,
            min: minY - Math.abs(minY)*0.15,
            max: maxY + Math.abs(maxY)*0.15,
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `x: ${ctx.parsed.x.toFixed(2)}, y: ${ctx.parsed.y.toFixed(2)}`
            }
          },
          annotation: {
            annotations: annotations
          }
        }
      },
      plugins: [Chart.registry.getPlugin('annotation')]
    });

    // Tabla de valores cada 0.5 para no saturar
    let tablaHtml = `<table><thead><tr><th>x</th><th>f(x)</th></tr></thead><tbody>`;
    for(let i=0; i<xs.length; i+=10) {
      tablaHtml += `<tr><td>${xs[i].toFixed(2)}</td><td>${ys[i].toFixed(4)}</td></tr>`;
    }
    tablaHtml += `</tbody></table>`;
    document.getElementById("tablaValores").innerHTML = tablaHtml;
  }
</script>

</body>
</html>
