<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Analizador de Ecuaciones</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f4f4;
      color: #222;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
    }
    code {
      background: #e8e8e8;
      padding: 3px 6px;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 6px 12px;
      text-align: center;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      overflow-x: auto;
    }
    #graph {
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>Calculadora de Ecuaciones con Dominio y Rango</h1>

  <label for="eq">Ingresa la ecuación (ej: 1 / (x + 2)):</label>
  <input type="text" id="eq" placeholder="Ejemplo: sin(x) / (x + 1)">
  <button onclick="analizar()">Calcular</button>

  <h2>Resultados:</h2>
  <p><strong>Dominio:</strong> <code id="dom"></code></p>
  <p><strong>Procedimiento para Rango:</strong></p>
  <pre id="proc"></pre>
  <p><strong>Rango estimado:</strong> <code id="ran"></code></p>

  <h3>Tabla de valores (x, f(x))</h3>
  <table>
    <thead><tr><th>x</th><th>f(x)</th></tr></thead>
    <tbody id="tabla"></tbody>
  </table>

  <div id="graph"></div>

  <script>
    function analizar() {
      const input = document.getElementById("eq").value;
      let domStr = "x ∈ ℝ";
      let rango = "y ∈ ℝ";
      let procedimiento = "";

      const xVals = [-3, -2, -1, 0, 1, 2, 3];
      const yVals = [];
      let tablaHTML = "";
      let minY = Infinity, maxY = -Infinity;

      try {
        const expr = math.parse(input);
        const compiled = math.compile(input);
        let exclusiones = [];

        // Detectar restricciones del dominio
        expr.traverse(function (node) {
          if (node.type === "OperatorNode" && node.op === "/") {
            const denom = node.args[1].toString();
            exclusiones.push(denom);
          }
          if (node.type === "FunctionNode" && node.fn.name === "sqrt") {
            const inside = node.args[0].toString();
            procedimiento += `Restricción: sqrt(${inside}) ⇒ ${inside} ≥ 0\n`;
          }
        });

        if (exclusiones.length > 0) {
          domStr = `x ∈ ℝ, x ≠ ${exclusiones.map(e => `raíz de (${e} = 0)`).join(", ")}`;
        }

        // Intentar despejar x a partir de y = f(x)
        const eqExpr = math.parse(`y - (${input})`);
        procedimiento += `Ecuación: y = ${input}\n`;

        try {
          const solutions = math.simplify(math.solve(eqExpr, 'x'));
          if (solutions.length > 0) {
            procedimiento += `Despejando x:\n⇒ x = ${solutions[0]}\n`;
            if (solutions[0].toString().includes("/y")) {
              rango = "y ∈ ℝ, y ≠ 0";
            }
          } else {
            procedimiento += "No se pudo despejar x simbólicamente.";
          }
        } catch (e) {
          procedimiento += "No se pudo despejar x simbólicamente.";
        }

        // Calcular tabla y extremos para rango estimado
        for (let x of xVals) {
          let scope = { x };
          let yVal = compiled.evaluate(scope);
          yVal = math.round(yVal, 5);
          yVals.push(yVal);
          if (!isNaN(yVal)) {
            minY = Math.min(minY, yVal);
            maxY = Math.max(maxY, yVal);
          }
          tablaHTML += `<tr><td>${x}</td><td>${yVal}</td></tr>`;
        }

        // Mostrar resultados
        document.getElementById("dom").textContent = `D = { ${domStr} }`;
        document.getElementById("proc").textContent = procedimiento;
        document.getElementById("ran").textContent = `R ≈ { y ∈ ℝ | ${minY} ≤ y ≤ ${maxY} }`;
        document.getElementById("tabla").innerHTML = tablaHTML;

        // Gráfica
        const trace = {
          x: xVals,
          y: yVals,
          mode: "lines+markers",
          type: "scatter",
          line: { color: "green" },
          marker: { color: "yellow", size: 8 }
        };

        Plotly.newPlot("graph", [trace], {
          title: "Gráfica de la función",
          xaxis: { title: "x" },
          yaxis: { title: "f(x)" },
          margin: { t: 40 }
        });

      } catch (err) {
        alert("Error: " + err.message);
      }
    }
  </script>

</body>
</html>
